#!/bin/bash
# Pre-commit hook for markdown link checking
# 
# Installation:
#   git config core.hooksPath .githooks
#
# Or copy to .git/hooks/:
#   cp .githooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if markdown-link-check is installed
if ! command -v markdown-link-check &> /dev/null; then
    echo -e "${YELLOW}Warning: markdown-link-check not installed${NC}"
    echo "Install with: npm install -g markdown-link-check"
    echo "Skipping link check..."
    exit 0
fi

# Create temporary config file
TMP_CONFIG=$(mktemp)
cat > "$TMP_CONFIG" << 'EOF'
{
  "ignorePatterns": [
    {
      "pattern": "^http://localhost"
    },
    {
      "pattern": "^https://localhost"
    },
    {
      "pattern": "^http://127.0.0.1"
    },
    {
      "pattern": "^https://127.0.0.1"
    },
    {
      "comment": "Ignore glossary internal anchors (too many to validate)",
      "pattern": "appendices/glossary.md#"
    }
  ],
  "timeout": "10s",
  "retryOn429": true,
  "retryCount": 2,
  "aliveStatusCodes": [200, 206, 301, 302, 307, 308, 403, 999]
}
EOF

echo -e "${YELLOW}Checking markdown links in staged files...${NC}"

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
    echo -e "${GREEN}No markdown files to check${NC}"
    rm "$TMP_CONFIG"
    exit 0
fi

# Check each file
ERRORS=0
for file in $STAGED_MD_FILES; do
    if [ -f "$file" ]; then
        echo -n "Checking: $file ... "
        if markdown-link-check "$file" --config "$TMP_CONFIG" --quiet > /dev/null 2>&1; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${RED}FAILED${NC}"
            echo -e "${RED}Broken links found in: $file${NC}"
            markdown-link-check "$file" --config "$TMP_CONFIG" 2>&1 | grep '\[âœ–\]' || true
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Cleanup
rm "$TMP_CONFIG"

# Exit with error if any files had broken links
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}====================================${NC}"
    echo -e "${RED}Link check failed for $ERRORS file(s)${NC}"
    echo -e "${RED}Please fix broken links before committing${NC}"
    echo -e "${RED}====================================${NC}"
    exit 1
fi

echo -e "${GREEN}All markdown links validated successfully${NC}"
exit 0
